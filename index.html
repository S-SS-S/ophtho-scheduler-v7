<!doctype html>
<html lang="ar" dir="rtl" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ophthalmology Visit Scheduler | حاسبة مواعيد العيون</title>
  <meta name="description" content="Compute the next ophthalmology visit based on condition, age (or age group), and last visit date. Arabic/English." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ["Tajawal","system-ui","-apple-system","Segoe UI","Roboto","Arial"] } } }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    html { scroll-behavior: smooth; }
    .card { @apply bg-white/80 dark:bg-slate-900/70 backdrop-blur shadow-lg rounded-2xl border border-gray-200 dark:border-slate-700; }
    .chip { @apply inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-xs border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800; }
    .btn { @apply px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700; }
    .error-text { @apply text-rose-600 dark:text-rose-300 text-xs mt-1; }
    .invalid { @apply border-rose-500 ring-4 ring-rose-200 dark:ring-rose-900/40; }
    @media print { html { color-scheme: light; } body { background: white !important; } .card { box-shadow: none; } .no-print { display: none !important; } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50 to-indigo-50 text-slate-800 dark:from-slate-900 dark:via-slate-900 dark:to-slate-900 dark:text-slate-100">
  <header class="max-w-5xl mx-auto px-4 pt-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <h1 id="title" class="text-2xl md:text-3xl font-bold">حاسبة مواعيد زيارة طبيب العيون</h1>
      <div class="flex flex-wrap items-center gap-2">
        <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm border border-slate-300 bg-white dark:bg-slate-800 dark:border-slate-600">
          <button id="lang-ar" class="font-medium" aria-pressed="true">العربية</button>
          <span class="mx-1">|</span>
          <button id="lang-en">English</button>
        </div>
        <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm border border-slate-300 bg-white dark:bg-slate-800 dark:border-slate-600" title="Theme">
          <button id="theme-light" class="font-medium">Light</button>
          <span class="mx-1">/</span>
          <button id="theme-dark">Dark</button>
        </div>
      </div>
    </div>
    <p id="subtitle" class="mt-2 text-slate-600 dark:text-slate-300">اختر الحالات، أدخل عمرك أو فئتك العمرية وتاريخ آخر زيارة، وسنحسب أقرب موعد.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <section class="card p-5 md:p-6">
      <form id="schedulerForm" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="flex items-center gap-2">
              <input id="ageGroupToggle" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <label for="ageGroupToggle" id="lblAgeGroupToggle" class="text-sm">استخدام الفئة العمرية بدلاً من تاريخ الميلاد</label>
            </div>
            <div id="dobWrap" class="space-y-2">
              <label for="dob" id="lblDob" class="block text-sm font-medium">تاريخ الميلاد</label>
              <input id="dob" name="dob" type="date" class="w-full rounded-2xl border-2 border-slate-300/90 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" />
              <p id="helpDob" class="text-xs text-slate-500">يُستخدم لحساب الفئة العمرية.</p>
              <p id="dobError" class="error-text hidden" aria-live="polite"></p>
            </div>
            <div id="ageGroupWrap" class="space-y-2 hidden">
              <label for="ageGroup" id="lblAgeGroup" class="block text-sm font-medium">الفئة العمرية</label>
              <select id="ageGroup" class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600">
                <option value="u40">&lt; 40</option>
                <option value="40-54">40–54</option>
                <option value="55-64">55–64</option>
                <option value=">=65">≥65</option>
              </select>
              <p id="helpAgeGroup" class="text-xs text-slate-500">اختر فقط إذا لم ترغب بإدخال تاريخ الميلاد.</p>
            </div>
          </div>
          <div class="space-y-2" id="lastVisitWrap">
            <label for="lastVisit" class="block text-sm font-medium"><span id="lblLastVisit">تاريخ آخر زيارة لطبيب العيون</span> <span class="text-rose-600" aria-hidden="true">*</span></label>
            <input id="lastVisit" name="lastVisit" type="date" required class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" aria-describedby="lastVisitHelp lastVisitError" />
            <p id="helpLastVisit" class="text-xs text-slate-500">مثال: 2024-12-05. لا تقبل تاريخًا مستقبليًا.</p>
            <p id="lastVisitError" class="error-text hidden" aria-live="polite"></p>
          </div>
        </div>

        <!-- Conditions searchable multi-select -->
        <div>
          <h2 id="condHeader" class="text-lg font-semibold mb-2">اختر الحالات/الظروف لديك</h2>
          <p id="condHelper" class="text-sm text-slate-600 dark:text-slate-300 mb-3">يمكنك اختيار أكثر من حالة؛ سنعرض أقرب موعد.</p>

          <div id="condMultiRoot" class="relative">
            <div id="condControl" class="flex flex-wrap items-center gap-2 p-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 cursor-text">
              <div id="selectedChips" class="flex flex-wrap gap-2"></div>
              <input id="condSearch" type="text" class="flex-1 min-w-[10ch] bg-transparent outline-none text-sm placeholder-slate-400 dark:placeholder-slate-500" placeholder="ابحث عن الحالة..." />
              <button id="clearConds" type="button" class="text-xs text-slate-500 hover:underline hidden">مسح</button>
            </div>
            <div id="condDropdown" class="absolute z-20 mt-1 w-full max-h-64 overflow-auto rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 shadow-xl hidden"></div>
          </div>
        </div>

        <!-- Conditional fields (shown for some conditions) -->
        <div id="conditionalFields" class="space-y-4 hidden">
          <h3 id="extraHeader" class="font-medium">معلومات إضافية مطلوبة لبعض الحالات</h3>
          <div id="extra-hcq" class="hidden">
            <label id="lblHcqYears" class="block text-sm font-medium mb-1" for="hcqYears">سنوات استخدام هيدروكسي كلوروكين/كلوروكين</label>
            <input id="hcqYears" type="number" min="0" step="1" class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" placeholder="6" />
            <p id="helpHcq" class="text-xs text-slate-500 mt-1">فحص سنوي بعد 5 سنوات من الاستخدام.</p>
          </div>
          <div id="extra-tamox" class="hidden">
            <label id="lblTamoxYears" class="block text-sm font-medium mb-1" for="tamoxYears">سنوات استخدام تاموكسيفين</label>
            <input id="tamoxYears" type="number" min="0" step="1" class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" placeholder="3" />
            <div class="mt-2 flex items-center gap-2">
              <input id="tamoxHighDose" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <label id="lblTamoxHighDose" for="tamoxHighDose" class="text-sm">جرعة مرتفعة</label>
            </div>
            <p id="helpTamox" class="text-xs text-slate-500 mt-1">فحص سنوي إذا المدة &gt; 5 سنوات أو الجرعة مرتفعة.</p>
          </div>
          <div id="extra-ted" class="hidden">
            <div class="flex items-center gap-2">
              <input id="tedActive" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <label id="lblTedActive" for="tedActive" class="text-sm">نشِط حاليًا (مرض عين درقي)</label>
            </div>
            <p id="helpTed" class="text-xs text-slate-500 mt-1">نشِط: كل 3–6 أشهر. مستقر: سنوي.</p>
          </div>
          <div id="extra-t1dm" class="hidden">
            <label id="lblT1Years" class="block text-sm font-medium mb-1" for="t1Years">سنوات منذ تشخيص سكري النوع الأول</label>
            <input id="t1Years" type="number" min="0" step="1" class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" placeholder="4" />
            <p id="helpT1" class="text-xs text-slate-500 mt-1">يبدأ الفحص بعد 5 سنوات من التشخيص، ثم سنويًا.</p>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 pt-2">
          <button type="submit" id="btnCalc" class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">احسب الزيارة القادمة</button>
          <button type="button" id="resetBtn" class="btn">إعادة ضبط</button>
          <button type="button" id="printBtn" class="btn ml-auto">طباعة/حفظ PDF</button>
        </div>
      </form>
    </section>

    <section id="resultsCard" class="card p-5 md:p-6 mt-6 hidden">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h2 id="resultsTitle" class="text-xl font-semibold">النتيجة</h2>
      </div>
      <div id="actionsPanel" class="no-print mt-3 p-3 rounded-2xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800">
        <div id="actionsTitle" class="text-sm font-medium mb-2">أدوات النتيجة</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <button id="copyBtn" class="btn w-full border-2 border-slate-400 dark:border-slate-500">Copy / Share</button>
          <button id="icsBtn" class="btn w-full border-2 border-slate-400 dark:border-slate-500">Add to Calendar (.ics)</button>
        </div>
        <label class="mt-3 inline-flex items-center gap-2 text-sm">
          <input id="earliestOnly" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
          <span id="lblEarliestOnly">Show only earliest</span>
        </label>
      </div>

      <p id="ruleExplain" class="mt-4 text-sm text-slate-600 dark:text-slate-300">عند تعدد الحالات نستخدم أقرب موعد آمن حسب اختيارك.</p>
      <div id="summary" class="mt-3 text-slate-700 dark:text-slate-200"></div>
      <div id="dueBanner" class="mt-3 hidden p-3 rounded-xl border text-sm"></div>
      <div id="details" class="mt-4 space-y-3"></div>
      <div id="disclaimer" class="mt-4 p-3 rounded-xl bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 text-amber-800 dark:text-amber-200 text-sm">
        تنبيه: هذه أداة تثقيفية ولا تُغني عن التقييم الطبي.
      </div>
    </section>

    <footer class="max-w-5xl mx-auto px-1 mt-10 mb-8 text-xs text-slate-500 dark:text-slate-400">
      <p id="footerText">تم عمل هذا الموقع من قبل سلطان الحسن، طبيب امتياز</p>
    </footer>
  </main>

</body>
</html>
